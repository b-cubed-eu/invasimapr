% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/process_site_sp_trait.R
\name{process_site_sp_trait}
\alias{process_site_sp_trait}
\title{Process site-level species–trait data}
\usage{
process_site_sp_trait(try_data, grid_obs, grid_sp, sp_cols, appendix = FALSE)
}
\arguments{
\item{try_data}{\code{character} or \code{data.frame}.  Either the path to a
tab-delimited TRY export or an in-memory data frame with the columns
\code{AccSpeciesName}, \code{TraitID}, \code{TraitName}, \code{OrigValueStr}.}

\item{grid_obs}{\code{data.frame}.  Long table (\code{grid_id}, \code{species})
listing every species observation per grid cell.}

\item{grid_sp}{\code{data.frame}.  Wide site × species matrix with coordinates;
must contain \code{grid_id}, \code{x}, \code{y} and the columns named in
\code{sp_cols}.}

\item{sp_cols}{\code{character}.  The species columns in \code{grid_sp} that
should be checked for matching trait data.}

\item{appendix}{\code{logical(1)}.  If \code{TRUE}, also returns
\code{sbt} (the unfiltered species × trait matrix) in addition to the core
outputs.  Defaults to \code{FALSE}.}
}
\value{
A list with components
\describe{
\item{\code{sp_traits}}{Matched species × trait data frame (wide).}
\item{\code{site_sp}}{Filtered site × species matrix (wide).}
\item{\code{site_xy}}{Data frame of \code{x}, \code{y} coordinates for the
sites in \code{site_sp}.}
\item{\code{traitname}}{Lookup table linking synthetic trait IDs
(\code{trait_1}, …) to original TRY trait names.}
\item{\code{species_mapping}}{Table mapping original species names to
matched TRY names.}
\item{\code{sbt}}{(Only if \code{appendix = TRUE}) the full
species × trait matrix before filtering.}
}
}
\description{
Harmonises raw TRY trait records with site–by–species occurrence tables
and returns matched, analysis-ready objects for functional‐diversity work.
The workflow:
\enumerate{
\item Imports or validates a TRY‐formatted data frame (or file).
\item Fuzzy-matches the species in \code{grid_obs} to accepted TRY names
(Jaro–Winkler distance \code{<= 0.05} via
\code{fuzzyjoin::stringdist_inner_join()}).
\item Aggregates multiple numeric observations per species–trait pair to a
single value, then reshapes to a wide species × trait matrix.
\item Filters the site × species matrix (\code{grid_sp}) to retain only
species with trait information.
\item Returns a named list containing the filtered site and trait tables,
spatial coordinates, a trait-name lookup, and (optionally) diagnostic
objects.
}
}
\details{
Non-numeric \code{OrigValueStr} entries are coerced to \code{NA}.
Where multiple trait measurements exist for a species, the first numeric
record is kept.  Users can adjust this behaviour manually after inspection of
the returned \code{sbt} object.
}
\examples{
\dontrun{
# --- toy data ------------------------------------------------------------
toy_try <- data.frame(
  AccSpeciesName = c("Acacia karroo", "Panicum maximum"),
  TraitID        = c(23, 23),
  TraitName      = c("Specific leaf area", "Specific leaf area"),
  OrigValueStr   = c("14.2", "28.1")
)

grid_obs <- data.frame(
  grid_id = c(1, 1, 2, 2),
  species = c("Acacia karroo", "Panicum maximum",
              "Acacia karoo",  "Panicum maximum")
)

grid_sp <- data.frame(
  grid_id = c(1, 2),
  x = c(30.1, 30.2),
  y = c(-24.8, -24.7),
  `Acacia karroo`   = c(1, 0),
  `Panicum maximum` = c(1, 1)
)

res <- process_site_sp_trait(
  try_data = toy_try,
  grid_obs = grid_obs,
  grid_sp  = grid_sp,
  sp_cols  = c("Acacia karroo", "Panicum maximum")
)
str(res)
}
}
\seealso{
\code{\link[fuzzyjoin]{stringdist_inner_join}},
\code{\link[rtry]{rtry_import}}
}
